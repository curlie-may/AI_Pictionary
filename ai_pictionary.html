<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Pictionary Game</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 1200px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .api-key-section {
            background: #f7f7f7;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .api-key-section input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 10px;
        }

        .game-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .video-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .info-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .word-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            font-size: 2em;
            font-weight: bold;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timer {
            background: #ff6b6b;
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            font-size: 3em;
            font-weight: bold;
        }

        .timer.warning {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .guesses-section {
            background: #f7f7f7;
            padding: 20px;
            border-radius: 15px;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
        }

        .guesses-section h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .guess-item {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .guess-item.correct {
            border-left-color: #51cf66;
            background: #d3f9d8;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            padding: 15px 40px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #51cf66;
            color: white;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .game-over {
            background: #fff3bf;
            border: 3px solid #ffd43b;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .game-over h2 {
            color: #f08c00;
            margin-bottom: 15px;
        }

        .game-over.win {
            background: #d3f9d8;
            border-color: #51cf66;
        }

        .game-over.win h2 {
            color: #2f9e44;
        }

        .loading {
            text-align: center;
            color: #667eea;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .game-area {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function PictionaryGame() {
            const [apiKey, setApiKey] = useState(localStorage.getItem('openai_api_key') || '');
            const [gameState, setGameState] = useState('setup');
            const [targetWord, setTargetWord] = useState('');
            const [timeLeft, setTimeLeft] = useState(60);
            const [guesses, setGuesses] = useState([]);
            const [gameResult, setGameResult] = useState(null);
            const [isGeneratingWord, setIsGeneratingWord] = useState(false);
            
            const videoRef = useRef(null);
            const streamRef = useRef(null);
            const guessIntervalRef = useRef(null);
            const timerIntervalRef = useRef(null);
            const isGameActiveRef = useRef(false);

            useEffect(() => {
                if (apiKey) {
                    localStorage.setItem('openai_api_key', apiKey);
                }
            }, [apiKey]);

            const speak = (text) => {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = 1.0;
                    utterance.pitch = 1.0;
                    utterance.volume = 1.0;
                    window.speechSynthesis.speak(utterance);
                }
            };

            const callOpenAI = async (messages, useVision = false) => {
                if (!apiKey) {
                    alert('Please enter your OpenAI API key first!');
                    return null;
                }

                try {
                    const requestBody = {
                        model: "gpt-4o",
                        messages: messages,
                        max_tokens: useVision ? 300 : 150,
                        temperature: 1.2
                    };

                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        console.error('OpenAI API Error:', error);
                        return null;
                    }

                    const data = await response.json();
                    return data.choices[0].message.content.trim();
                } catch (error) {
                    console.error('Error calling OpenAI:', error);
                    return null;
                }
            };

            const generateWord = async () => {
                setIsGeneratingWord(true);
                
                const categories = [
                    "animals",
                    "vehicles and transportation",
                    "household items and furniture",
                    "food and drinks",
                    "nature and plants",
                    "sports equipment",
                    "tools and instruments",
                    "buildings and structures",
                    "clothing and accessories",
                    "electronics and technology"
                ];
                
                const randomCategory = categories[Math.floor(Math.random() * categories.length)];
                const randomSeed = Math.floor(Math.random() * 1000000);
                
                const prompt = [
                    {
                        role: "system",
                        content: "You are a word generator for a Pictionary game. Generate a single word that represents a concrete, drawable object. The word should be something that can be visually represented through a drawing. Vary the difficulty - sometimes use common objects (like 'car', 'tree', 'house'), sometimes use moderately challenging objects (like 'telescope', 'volcano', 'pyramid'), and occasionally use more difficult but still drawable objects (like 'microscope', 'cathedral', 'octopus'). Only respond with the single word, nothing else. No explanations, no punctuation, just the word."
                    },
                    {
                        role: "user",
                        content: `Generate a drawable object word for Pictionary from the category: ${randomCategory}. Random seed: ${randomSeed}`
                    }
                ];

                const word = await callOpenAI(prompt);
                setIsGeneratingWord(false);
                if (word) {
                    setTargetWord(word);
                    setGameState('ready');
                }
            };

            const captureImage = () => {
                if (!videoRef.current) return null;
                
                const canvas = document.createElement('canvas');
                canvas.width = videoRef.current.videoWidth;
                canvas.height = videoRef.current.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(videoRef.current, 0, 0);
                return canvas.toDataURL('image/jpeg', 0.8);
            };

            const makeGuess = async () => {
                if (!isGameActiveRef.current) return;
                
                const imageBase64 = captureImage();
                if (!imageBase64) return;

                const messages = [
                    {
                        role: "system",
                        content: "You are an AI playing Pictionary. You're looking at a drawing on paper captured by a webcam. The person is drawing an object. Analyze the drawing and make your best guess about what object is being drawn. Consider shapes, lines, and any recognizable features. Respond with ONLY your guess - a single word or short phrase (2-3 words max) representing the object. Be specific but not overly detailed. If the drawing is unclear or just starting, make an educated guess based on what you can see. Examples of good guesses: 'cat', 'car', 'tree', 'coffee cup', 'bicycle'."
                    },
                    {
                        role: "user",
                        content: [
                            {
                                type: "text",
                                text: "What object is being drawn in this image?"
                            },
                            {
                                type: "image_url",
                                image_url: {
                                    url: imageBase64
                                }
                            }
                        ]
                    }
                ];

                const guess = await callOpenAI(messages, true);
                
                if (!isGameActiveRef.current || !guess) return;
                
                const isCorrect = await checkGuess(guess);
                
                if (!isGameActiveRef.current) return;
                
                const guessObj = {
                    text: guess,
                    timestamp: new Date().toLocaleTimeString(),
                    correct: isCorrect
                };
                
                setGuesses(prev => [...prev, guessObj]);
                speak(guess);

                if (isCorrect) {
                    endGame('win');
                }
            };

            const checkGuess = async (guess) => {
                const guessLower = guess.toLowerCase();
                const targetLower = targetWord.toLowerCase();
                
                if (guessLower.includes(targetLower)) {
                    return true;
                }
                
                const messages = [
                    {
                        role: "system",
                        content: `You are a judge for a Pictionary game. Determine if the guess matches the target word. The guess should be considered correct if it's semantically equivalent, a synonym, or a very close match. Be reasonably lenient - accept related terms, plural/singular variations, and common synonyms. For example: 'cat' matches 'feline', 'kitten', or 'kitty'; 'car' matches 'automobile', 'vehicle'; 'house' matches 'home', 'building'. Respond with ONLY 'YES' if it's a match or 'NO' if it's not. No explanations.`
                    },
                    {
                        role: "user",
                        content: `Target word: "${targetWord}"\nGuess: "${guess}"\nDoes the guess match the target word?`
                    }
                ];

                const result = await callOpenAI(messages);
                return result && result.toUpperCase().includes('YES');
            };

            const startWebcam = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    });
                    streamRef.current = stream;
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                    }
                } catch (error) {
                    console.error('Error accessing webcam:', error);
                    alert('Could not access webcam. Please ensure you have granted camera permissions.');
                }
            };

            const stopWebcam = () => {
                if (streamRef.current) {
                    streamRef.current.getTracks().forEach(track => track.stop());
                    streamRef.current = null;
                }
                if (videoRef.current) {
                    videoRef.current.srcObject = null;
                }
            };

            const handleStartGame = async () => {
                await generateWord();
                await startWebcam();
            };

            const handleStartTimer = () => {
                setGameState('playing');
                setTimeLeft(60);
                setGuesses([]);
                isGameActiveRef.current = true;

                timerIntervalRef.current = setInterval(() => {
                    setTimeLeft(prev => {
                        if (prev <= 1) {
                            endGame('timeout');
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);

                guessIntervalRef.current = setInterval(() => {
                    makeGuess();
                }, 5000);

                setTimeout(makeGuess, 1000);
            };

            const endGame = (result) => {
                isGameActiveRef.current = false;
                
                setGameState('ended');
                setGameResult(result);
                
                if (timerIntervalRef.current) {
                    clearInterval(timerIntervalRef.current);
                }
                if (guessIntervalRef.current) {
                    clearInterval(guessIntervalRef.current);
                }

                stopWebcam();

                if (result === 'win') {
                    speak(`Correct! The word was ${targetWord}!`);
                } else {
                    speak(`Time's up! The word was ${targetWord}.`);
                }
            };

            const handlePlayAgain = () => {
                setGameState('setup');
                setTargetWord('');
                setTimeLeft(60);
                setGuesses([]);
                setGameResult(null);
            };

            useEffect(() => {
                return () => {
                    stopWebcam();
                    if (timerIntervalRef.current) clearInterval(timerIntervalRef.current);
                    if (guessIntervalRef.current) clearInterval(guessIntervalRef.current);
                };
            }, []);

            return (
                <div className="container">
                    <h1>🎨 AI Pictionary Game</h1>

                    {gameState === 'setup' && (
                        <>
                            <div className="api-key-section">
                                <label htmlFor="apiKey">
                                    <strong>OpenAI API Key:</strong>
                                    <input
                                        id="apiKey"
                                        type="password"
                                        placeholder="Enter your OpenAI API key (sk-...)"
                                        value={apiKey}
                                        onChange={(e) => setApiKey(e.target.value)}
                                    />
                                </label>
                                <p style={{marginTop: '10px', fontSize: '0.9em', color: '#666'}}>
                                    Your API key is stored locally in your browser.
                                </p>
                            </div>

                            <div className="controls">
                                <button 
                                    className="btn-primary" 
                                    onClick={handleStartGame}
                                    disabled={!apiKey || isGeneratingWord}
                                >
                                    {isGeneratingWord ? 'Generating Word...' : 'Start Game'}
                                </button>
                            </div>
                        </>
                    )}

                    {(gameState === 'ready' || gameState === 'playing' || gameState === 'ended') && (
                        <>
                            {gameState === 'ended' && (
                                <div className={`game-over ${gameResult === 'win' ? 'win' : ''}`}>
                                    <h2>
                                        {gameResult === 'win' ? '🎉 You Won!' : '⏰ Time\'s Up!'}
                                    </h2>
                                    <p style={{fontSize: '1.2em', marginTop: '10px'}}>
                                        The word was: <strong>{targetWord}</strong>
                                    </p>
                                </div>
                            )}

                            <div className="game-area">
                                <div className="video-section">
                                    <div style={{
                                        width: '100%',
                                        aspectRatio: '16/9',
                                        borderRadius: '10px',
                                        border: '3px solid #667eea',
                                        background: '#000',
                                        overflow: 'hidden',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center'
                                    }}>
                                        {gameState !== 'ended' ? (
                                            <video 
                                                ref={videoRef} 
                                                autoPlay 
                                                playsInline
                                                style={{
                                                    width: '100%',
                                                    height: '100%',
                                                    objectFit: 'cover'
                                                }}
                                            />
                                        ) : (
                                            <div style={{
                                                color: 'white',
                                                fontSize: '1.2em'
                                            }}>
                                                Camera Off
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="info-section">
                                    <div className="word-display">
                                        {targetWord.toUpperCase()}
                                    </div>

                                    <div className={`timer ${timeLeft <= 10 ? 'warning' : ''}`}>
                                        {timeLeft}s
                                    </div>

                                    <div className="guesses-section">
                                        <h3>AI Guesses:</h3>
                                        {guesses.length === 0 && gameState === 'playing' && (
                                            <p className="loading">Waiting for first guess...</p>
                                        )}
                                        {guesses.map((guess, index) => (
                                            <div key={index} className={`guess-item ${guess.correct ? 'correct' : ''}`}>
                                                <strong>{guess.text}</strong>
                                                <span style={{float: 'right', fontSize: '0.8em', color: '#888'}}>
                                                    {guess.timestamp}
                                                </span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <div className="controls">
                                {gameState === 'ready' && (
                                    <button className="btn-success" onClick={handleStartTimer}>
                                        Start Timer
                                    </button>
                                )}
                                {gameState === 'ended' && (
                                    <button className="btn-primary" onClick={handlePlayAgain}>
                                        Play Again
                                    </button>
                                )}
                            </div>
                        </>
                    )}
                </div>
            );
        }

        ReactDOM.render(<PictionaryGame />, document.getElementById('root'));
    </script>
</body>
</html>